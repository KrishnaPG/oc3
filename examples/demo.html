<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>oc3 â€“ 60k Physics Showcase</title>
  <style>html,body{margin:0;height:100%;background:#000;font-family:sans-serif}</style>
</head>
<body>
<div id="root"></div>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18",
    "react-dom": "https://esm.sh/react-dom@18",
    "@react-three/fiber": "https://esm.sh/@react-three/fiber@8",
    "@react-three/drei": "https://esm.sh/@react-three/drei@9",
    "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2",
    "leva": "https://esm.sh/leva@0.9",
    "oc3": "https://unpkg.com/oc3@latest/dist/esm/index.js"
  }
}
</script>
<script type="module">
import React, { useEffect, useRef, useState, useMemo, Suspense } from 'react'
import { createRoot } from 'react-dom/client'
import { Canvas, useFrame, useThree } from '@react-three/fiber'
import { OrbitControls, PointerLockControls, Sphere, Box } from '@react-three/drei'
import { EffectComposer, Bloom } from '@react-three/postprocessing'
import { useControls, button } from 'leva'
import { OctreeProxy } from 'oc3/worker-proxy'
import { OctreeProvider, useOctree } from 'oc3/r3f'

/* ---------- Web-Worker backend ---------- */
const worker = new Worker(
  URL.createObjectURL(
    new Blob([`
import { OctreeWorkerBackend } from 'https://unpkg.com/oc3@latest/dist/esm/worker-backend.js'
new OctreeWorkerBackend(self)
`], { type: 'text/javascript' })
  )
)
const octree = new OctreeProxy(worker)

/* ---------- Scene ---------- */
function Scene() {
  const { camera, gl } = useThree()
  const [score, setScore] = useState(0)
  const [resetKey, setResetKey] = useState(0)
  const [particles, setParticles] = useState([]) // {pos,color,id}

  const { gravity, speed } = useControls({
    gravity: { value: 12, min: 0, max: 30 },
    speed: { value: 8, min: 1, max: 20 },
    reset: button(() => setResetKey(k => k + 1))
  })

  /* ---------- Build 60k objects ---------- */
  const objects = useMemo(() => {
    const arr = []
    for (let i = 0; i < 30_000; i++) {
      const pos = [Math.random() * 500 - 250, Math.random() * 50, Math.random() * 500 - 250]
      arr.push({ id: i, type: 'box', pos })
    }
    for (let i = 30_000; i < 60_000; i++) {
      const pos = [Math.random() * 500 - 250, Math.random() * 50, Math.random() * 500 - 250]
      arr.push({ id: i, type: 'sphere', pos })
    }
    return arr
  }, [resetKey])

  /* ---------- Insert into oc3 worker ---------- */
  useEffect(() => {
    const batch = objects.map(o => ({
      cmd: 'insert',
      id: o.id,
      aabb: new Float32Array([...o.pos, ...o.pos].map((v, i) => v + (i < 3 ? -0.5 : 0.5)))
    }))
    octree.postBatch(batch)
  }, [objects])

  /* ---------- FPS controls ---------- */
  const ref = useRef()
  const vel = useRef([0, 0, 0])
  useEffect(() => {
    gl.domElement.requestPointerLock()
    const onKey = e => {
      if (e.code === 'Space') vel.current[1] = speed
    }
    window.addEventListener('keydown', onKey)
    return () => window.removeEventListener('keydown', onKey)
  }, [speed])

  useFrame((_, dt) => {
    const [x, y, z] = vel.current
    vel.current[1] = Math.max(y - gravity * dt, 0)
    camera.position.y += y * dt
    if (camera.position.y < 2) camera.position.y = 2
    ref.current = camera
  })

  /* ---------- Shooting ---------- */
  useEffect(() => {
    const shoot = e => {
      const raycaster = new THREE.Raycaster()
      raycaster.setFromCamera({ x: 0, y: 0 }, camera)
      const hits = []
      octree.raycast(raycaster.ray, hits)
      if (hits.length) {
        const id = hits[0].objectId
        octree.postBatch([{ cmd: 'remove', id }])
        setScore(s => s + 1)
        const obj = objects.find(o => o.id === id)
        if (obj) {
          const color = new THREE.Color(Math.random(), 0.5, 1)
          setParticles(p => [...p, { pos: obj.pos, color, id: Date.now() + id }])
        }
      }
    }
    window.addEventListener('click', shoot)
    return () => window.removeEventListener('click', shoot)
  }, [camera, objects])

  /* ---------- LOD culling ---------- */
  const visible = useRef([])
  useFrame(() => {
    const frustum = new THREE.Frustum().setFromProjectionMatrix(camera.projectionMatrix.clone().multiply(camera.matrixWorldInverse))
    const v = []
    octree.frustumQuery(frustum, id => v.push(id))
    visible.current = v
  })

  return (
    <>
      <PointerLockControls />
      <ambientLight intensity={0.4}/>
      <pointLight position={[100, 100, 100]} intensity={1}/>
      <Suspense fallback={null}>
        {objects.map(o => {
          const show = visible.current.includes(o.id)
          if (!show) return null
          const [x, y, z] = o.pos
          const key = o.id
          if (o.type === 'box') {
            return <Box key={key} args={[1, 1, 1]} position={[x, y, z]}><meshStandardMaterial color="#0ff"/></Box>
          } else {
            return <Sphere key={key} args={[0.5, 16, 16]} position={[x, y, z]}><meshStandardMaterial color="#f0f"/></Sphere>
          }
        })}
        {particles.map(({ pos, color, id }) => (
          <Explosion key={id} pos={pos} color={color}/>
        ))}
      </Suspense>
    </>
  )
}

/* ---------- Particle Explosion ---------- */
function Explosion({ pos, color }) {
  const ref = useRef()
  useFrame((_, dt) => {
    if (ref.current) {
      ref.current.children.forEach(c => c.position.addScaledVector(c.userData.vel, dt))
      ref.current.children.forEach(c => c.scale.multiplyScalar(0.95))
    }
  })
  return (
    <group ref={ref} position={pos}>
      {Array.from({ length: 20 }).map((_, i) => {
        const dir = new THREE.Vector3(Math.random() - 0.5, Math.random(), Math.random() - 0.5).normalize()
        return (
          <Box key={i} args={[0.2, 0.2, 0.2]} position={[0, 0, 0]} userData={{ vel: dir.multiplyScalar(10) }}>
            <meshBasicMaterial color={color} />
          </Box>
        )
      })}
    </group>
  )
}

/* ---------- UI ---------- */
function UI() {
  const { score } = useControls({ score: { value: 0, render: () => false } })
  return (
    <div style={{ position: 'absolute', top: 20, left: 20, color: 'white', fontSize: 32 }}>
      Hits: {score}
    </div>
  )
}

/* ---------- App ---------- */
createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <Canvas shadows camera={{ fov: 75, position: [0, 5, 0] }}>
      <OctreeProvider octree={octree}>
        <Scene/>
        <EffectComposer>
          <Bloom luminanceThreshold={0.2} intensity={1}/>
        </EffectComposer>
      </OctreeProvider>
    </Canvas>
    <UI/>
  </React.StrictMode>
)
</script>
</body>
</html>